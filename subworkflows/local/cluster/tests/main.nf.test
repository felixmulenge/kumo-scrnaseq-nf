nextflow_workflow {

    name "Test Workflow CLUSTER"
    script "subworkflows/local/cluster/main.nf"
    workflow "CLUSTER"

    tag "subworkflows"
    tag "subworkflows_local"

    test("Should run without failures - global - stub") {

        options '-stub'

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = channel.of([
                        [ id: 'test', integration: 'pca' ],
                        file(params.pipelines_testdata_base_path + '/extension_base/merged.h5ad', checkIfExists: true)
                    ]
                )
                input[1] = false
                input[2] = true
                input[3] = ''
                input[4] = channel.of('0.5', '1')
                input[5] = 'sample'
                input[6] = 'X_scvi'
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out).match()
        }

    }

    test("Should run without failures - global") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = channel.of([
                        [ id: 'test', integration: 'pca' ],
                        file(params.pipelines_testdata_base_path + '/extension_base/merged.h5ad', checkIfExists: true)
                    ]
                )
                input[1] = false
                input[2] = true
                input[3] = ''
                input[4] = channel.of('0.5', '1')
                input[5] = 'sample'
                input[6] = 'X_scvi'
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out).match()
        }

    }

    test("Should run without failures - per-label - stub") {

        options '-stub'

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = channel.of([
                        [ id: 'test', integration: 'pca' ],
                        file(params.pipelines_testdata_base_path + '/extension_base/merged.h5ad', checkIfExists: true)
                    ]
                )
                input[1] = true
                input[2] = false
                input[3] = 'sample'
                input[4] = channel.of('0.5', '1')
                input[5] = 'sample'
                input[6] = 'X_scvi'
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out).match()
        }

    }

    test("Should run without failures - per-label") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = channel.of([
                        [ id: 'test', integration: 'pca' ],
                        file(params.pipelines_testdata_base_path + '/extension_base/merged.h5ad', checkIfExists: true)
                    ]
                )
                input[1] = true
                input[2] = false
                input[3] = 'sample'
                input[4] = channel.of('0.5', '1')
                input[5] = 'sample'
                input[6] = 'X_scvi'
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out).match()
        }

    }

    test("Should run without failures - both - stub") {

        options '-stub'

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = channel.of([
                        [ id: 'test', integration: 'pca' ],
                        file(params.pipelines_testdata_base_path + '/extension_base/merged.h5ad', checkIfExists: true)
                    ]
                )
                input[1] = true
                input[2] = true
                input[3] = 'sample'
                input[4] = channel.of('0.5', '1')
                input[5] = 'sample'
                input[6] = 'X_scvi'
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out).match()
        }

    }

    test("Should run without failures - both") {

        when {
            params {
                outdir = "$outputDir"
            }
            workflow {
                """
                input[0] = channel.of([
                        [ id: 'test', integration: 'pca' ],
                        file(params.pipelines_testdata_base_path + '/extension_base/merged.h5ad', checkIfExists: true)
                    ]
                )
                input[1] = true
                input[2] = true
                input[3] = 'sample'
                input[4] = channel.of('0.5', '1')
                input[5] = 'sample'
                input[6] = 'X_scvi'
                """
            }
        }

        then {
            assert workflow.success
            assert snapshot(workflow.out).match()
        }

    }

}
